pipeline{
    agent any
    environment {
      DOCKER_PROD_HOST="tcp://45.155.170.65:2375"
      DOCKER_PRIVATE_REGISTER="registry.dsp-archiwebo21-ct-df-an-cd.fr"
      REGISTRY_CRED=credentials('jenkins-registry-credential')
      IMAGE_TAG=sh(returnStdout: true, script: 'cat infra/build/version | tail -1').trim()
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======

>>>>>>> 34a778e (Set up infra as code)
=======
>>>>>>> d6f013a (Add API_HOST env to prod and release)
=======
>>>>>>> a584e821a7aee8a69ef870781d3a7bb3e50d105c
    }
    stages{

        stage("build") {
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 1910a61 (Update jenkins file and integrate changes)
=======
>>>>>>> a584e821a7aee8a69ef870781d3a7bb3e50d105c
            when { expression { BRANCH_NAME ==~ /(main|release)/ } }
                    parallel {
                  
                         stage("release"){  
                                when {branch 'release'}
<<<<<<< HEAD
=======
                    parallel {
                  
                         stage("release"){  
<<<<<<< HEAD
                                //when {branch 'release'}
>>>>>>> 34a778e (Set up infra as code)
=======
                                when {branch 'release'}
>>>>>>> bccb529 (Back to the default stable docker Image)
=======
>>>>>>> a584e821a7aee8a69ef870781d3a7bb3e50d105c
                                  steps{
                                    sh "infra/scripts/build.sh frontend release"  
                                 }
                         }

                        stage("stable"){
                            when{branch 'main'}
                               steps{
                                sh "infra/scripts/build.sh frontend stable"     
                             } 
                        
                         }
              
                     }
              }

<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
        stage("registry") {
                when { expression { BRANCH_NAME ==~ /(main|release)/ } }
<<<<<<< HEAD
=======
        stage("private docker hub") {
=======
        stage("private docker") {
>>>>>>> ea7e253 (Update the jenkinsFile)
=======
        stage("registry") {
>>>>>>> a22a118 (Update the jenkinsFile)
                //when { expression { BRANCH_NAME ==~ /(main|release)/ } }
>>>>>>> 34a778e (Set up infra as code)
=======
>>>>>>> bccb529 (Back to the default stable docker Image)
=======
        stage("registry") {
                when { expression { BRANCH_NAME ==~ /(main|release)/ } }
>>>>>>> a584e821a7aee8a69ef870781d3a7bb3e50d105c
                stages {

                      stage("login"){
                         
                        steps{
                               echo "Login to the docker private registry"
                               sh "docker login -u ${REGISTRY_CRED_USR} -p ${REGISTRY_CRED_PSW} https://${DOCKER_PRIVATE_REGISTER}"    
                           }
                        }
                      
                      stage("push"){
                            
                             steps{
                                     echo "push frontend image to the docker private registry"
                                      sh "infra/scripts/registry.sh frontend"    
                                }

                          post {
                              always {
                                 sh "docker system prune -af"
                              }
                          }
                     }
                }
             }

        stage("test"){
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> a584e821a7aee8a69ef870781d3a7bb3e50d105c
            when {branch "dev"}
            agent {docker {image "node:14-alpine"}}

            stages {
                stage("setup"){
<<<<<<< HEAD
=======
            agent {
                docker {
                    image "node:alpine"
                }
            }

            stages {
                stage("setup"){
                   when {
                       branch "dev"
                   }
>>>>>>> 34a778e (Set up infra as code)
=======
             when {branch "dev"}
            agent {docker {image "node:alpine"}}
=======
            when {branch "dev"}
            agent {docker {image "node:14-alpine"}}
>>>>>>> 1910a61 (Update jenkins file and integrate changes)

            stages {
                stage("setup"){
>>>>>>> ef5d35b (Update jenkins File)
                   steps{
                           sh "node --version"
<<<<<<< HEAD
<<<<<<< HEAD
                           sh "npm version"
                           sh "npm install"
<<<<<<< HEAD
<<<<<<< HEAD
                           sh "npm run build"
=======
>>>>>>> 34a778e (Set up infra as code)
=======
                           //sh "npm version"
                           sh "yarn install"
>>>>>>> b90496c (Update jenkins file and integrate changes)
=======
                           sh "npm version"
                           sh "npm install"
>>>>>>> 35413ac (add package.lock.json to gitignore)
=======
                           sh "npm run build"
>>>>>>> dea6564 (update jenkinsFile)
=======
                   steps{
                           sh "node --version"
                           sh "npm version"
                           sh "npm install"
                           sh "npm run build"
>>>>>>> a584e821a7aee8a69ef870781d3a7bb3e50d105c
                       }
                   
                }
                 stage("coverage") {
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
                    when {branch "dev"}
>>>>>>> 34a778e (Set up infra as code)
=======
>>>>>>> ef5d35b (Update jenkins File)
=======
>>>>>>> a584e821a7aee8a69ef870781d3a7bb3e50d105c
                    steps{
                     echo "Any  cov test to achieve"
                     //sh "npm run test:cov"
                     //sh "scripts/test.sh cov"
                    }

                 post{
                     always{  
                        clover(cloverReportDir: 'coverage', cloverReportFileName: 'clover.xml',
                            // optional, default is: method=70, conditional=80, statement=80
                            healthyTarget: [methodCoverage: 70, conditionalCoverage: 80, statementCoverage: 80],
                            // optional, default is none
                            unhealthyTarget: [methodCoverage: 50, conditionalCoverage: 50, statementCoverage: 50],
                            // optional, default is none
                            failingTarget: [methodCoverage: 0, conditionalCoverage: 0, statementCoverage: 0]
                        )
                    }
                     
                 }
              }

                 /*stage("e2e"){
                     when {branch "dev"}
                     steps{
                        echo "handle e2e test"
                        //sh "npm run test:e2e" 
                     }
                 }*/
            }
        }

        stage("deploy"){ 
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 1910a61 (Update jenkins file and integrate changes)
=======
>>>>>>> a584e821a7aee8a69ef870781d3a7bb3e50d105c
            when { expression { BRANCH_NAME ==~ /(main|release)/ } }
            parallel{
                stage ('release'){
                    when{ branch 'release'}
<<<<<<< HEAD
=======
            parallel{
                stage ('release'){
<<<<<<< HEAD
                    //when{ branch 'release'}
>>>>>>> 34a778e (Set up infra as code)
=======
                    when{ branch 'release'}
>>>>>>> bccb529 (Back to the default stable docker Image)
=======
>>>>>>> a584e821a7aee8a69ef870781d3a7bb3e50d105c
                    steps{
                        sshagent(credentials: ['devops-sshkey-private']) {
                               echo "copy release infra folder env on prod remote"
                               echo "Add execute permission to the start.sh file on remote"
                               sh "infra/scripts/deploy.sh release"
                        }
                           
                    }
                }

                stage('prod'){
                    when { branch 'main' }
                    steps {
                        sshagent(credentials: ['devops-sshkey-private']) {
                             echo "copy prod infra folder env on remote"
                             echo "Add execute permission to start.sh file on remote"
                             sh "infra/scripts/deploy.sh prod"
                        }                          
                    }
                }
            }                 
        }
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 55bbc12 (Add end stage)
=======
>>>>>>> a584e821a7aee8a69ef870781d3a7bb3e50d105c

        stage("end") {
            steps{
                echo "Successful end"
            }
        }
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 34a778e (Set up infra as code)
=======
>>>>>>> 55bbc12 (Add end stage)
=======
>>>>>>> a584e821a7aee8a69ef870781d3a7bb3e50d105c
    }
}
